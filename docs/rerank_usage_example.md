# LLM重排序功能使用指南

## 功能概述

LLM重排序功能通过使用大语言模型对初始检索结果进行相关性评分和重新排序，显著提高检索准确性。该功能与现有的语义分块功能完美配合，为Web RAG系统提供更精准的文档检索能力。

> **状态**: ✅ 已完全实现并集成到系统中

## 核心特性

- **✅ 智能重排序**: 使用LLM深度理解查询意图，对检索结果进行语义相关性评分
- **✅ 多样性感知检索**: 确保检索结果包含来自不同文档源的内容，避免单一文档主导
- **✅ 文件名匹配增强**: 在向量检索基础上增加文件名/标题匹配，提高特定文档查询准确性
- **✅ 可配置参数**: 支持灵活配置初始检索数量、最终返回数量、评分阈值等参数
- **✅ 性能优化**: 集成高效缓存机制和性能监控，确保稳定运行
- **✅ 降级处理**: 当重排序失败时自动降级到传统检索，保证系统稳定性
- **✅ 向后兼容**: 可通过配置开关完全禁用，不影响现有功能
- **✅ 缓存优化**: 解决Document对象序列化问题，支持高效缓存

## 🆕 多样性感知检索

### 问题背景
在多文档环境中，传统的向量检索可能会被单一文档的大量片段主导，导致其他文档的相关内容被忽略。例如：
- 文档A有40个片段，文档B只有1个片段
- 查询关于文档B的内容时，Top-8结果可能全部来自文档A
- 重排序LLM无法看到文档B的内容，导致无法正确回答

### 解决方案
多样性感知检索器通过以下策略确保文档来源的多样性：

1. **扩大初始检索范围**: 检索更多候选文档（通常是目标数量的3倍）
2. **按文档源分组**: 将检索结果按文档来源进行分组
3. **轮询选择策略**: 从每个文档源轮流选择片段，确保平衡
4. **智能降级**: 当文档源不足时自动调整策略

### 配置参数
```bash
# 是否启用多样性感知检索
USE_DIVERSITY_RETRIEVAL=True

# 每个文档源最多返回的片段数
DIVERSITY_MAX_PER_SOURCE=3

# 最少文档源数量
DIVERSITY_MIN_SOURCES=2
```

## 配置说明

### 环境变量配置 (.env)

```bash
# =============================================================================
# LLM重排序配置（可选）
# =============================================================================
# 是否启用LLM重排序功能
USE_RERANK=true

# 初始检索文档数量（扩大检索范围以获得更多候选文档）
RERANK_INITIAL_K=8

# 最终返回文档数量
RERANK_FINAL_K=4

# 相关性评分阈值（0-1之间，低于此分数的文档将被过滤）
RERANK_SCORE_THRESHOLD=0.6

# 重排序结果缓存时间（秒）
RERANK_CACHE_TTL=3600

# 重排序LLM温度参数（较低值确保评分一致性）
RERANK_TEMPERATURE=0.1

# 重排序失败重试次数
RERANK_MAX_RETRIES=3

# =============================================================================
# 多样性感知检索配置（可选）
# =============================================================================
# 是否启用多样性感知检索
USE_DIVERSITY_RETRIEVAL=true

# 每个文档源最多返回的片段数
DIVERSITY_MAX_PER_SOURCE=3

# 最少文档源数量
DIVERSITY_MIN_SOURCES=2

# =============================================================================
# 文件名匹配增强配置（可选）
# =============================================================================
# 是否启用文件名搜索
ENABLE_FILENAME_SEARCH=true

# 文件名匹配权重（0-1之间）
FILENAME_SEARCH_WEIGHT=0.3

# 语义搜索权重（0-1之间）
SEMANTIC_SEARCH_WEIGHT=0.7

# 文件名匹配最低分数阈值
MIN_FILENAME_SCORE=0.2

# 文件名匹配增强分数
FILENAME_BOOST_SCORE=0.2

# 文件名匹配阈值
FILENAME_MATCH_THRESHOLD=0.3
```

### 代码配置

```python
from src.infrastructure.config.configuration_service import ConfigurationService

config = ConfigurationService()

# 动态调整重排序参数
config.set_value("use_rerank", True)
config.set_value("rerank_initial_k", 10)  # 扩大初始检索范围
config.set_value("rerank_final_k", 5)     # 增加最终返回数量
```

## 使用方式

### 自动集成（推荐）

重排序功能已自动集成到系统中，上传文档后直接进行问答即可体验重排序效果。无需额外配置或代码修改。

### 配置控制

通过环境变量控制重排序功能：

```bash
# 启用/禁用重排序
USE_RERANK=true

# 调整重排序参数
RERANK_INITIAL_K=8              # 初始检索数量
RERANK_FINAL_K=4                # 最终返回数量
RERANK_SCORE_THRESHOLD=0.6      # 评分阈值

# 多样性检索配置
USE_DIVERSITY_RETRIEVAL=true    # 启用多样性检索
DIVERSITY_MAX_PER_SOURCE=3      # 每个文档源最大片段数

# 文件名匹配配置
ENABLE_FILENAME_SEARCH=true     # 启用文件名搜索
FILENAME_SEARCH_WEIGHT=0.3      # 文件名匹配权重
```

## 最佳实践

### 参数调优建议

- **初始检索数量**: 建议设置为最终返回数量的2-3倍
- **评分阈值**: 0.6是较好的起始值，可根据业务需求调整
- **多样性检索**: 在多文档环境中建议启用，避免单一文档主导

### 性能优化

- 系统自动启用缓存，避免重复计算相同查询
- 重排序失败时自动降级到传统检索，确保系统稳定性
- 可通过日志监控重排序效果和性能指标

## 与语义分块的协同效果

重排序功能与现有的语义分块功能形成完美互补：

1. **语义分块**: 在文档预处理阶段保持语义完整性
2. **LLM重排序**: 在查询检索阶段提升相关性排序

这种组合显著提升了整体检索质量，特别是在处理复杂查询和长文档时效果更加明显。

## 故障排除

### 常见问题

1. **重排序失败**: 检查 `GOOGLE_API_KEY` 是否正确设置
2. **性能较慢**: 考虑减少初始检索数量 (`RERANK_INITIAL_K`)
3. **结果不理想**: 调整评分阈值 (`RERANK_SCORE_THRESHOLD`)

### 调试模式

设置环境变量启用详细日志：
```bash
DEBUG=true
LOG_LEVEL=DEBUG
```

## 总结

LLM重排序功能显著提升了RAG系统的检索质量，通过智能的语义理解和多样性检索，确保用户获得最相关的文档内容。该功能已完全集成到系统中，具备完善的配置管理和错误处理机制。
